<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autonomous Incident Commander - Live Backend Integration</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
        color: #ffffff;
        overflow-x: hidden;
      }

      .dashboard-header {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .logo i {
        font-size: 2rem;
        color: #00d4ff;
      }

      .logo h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #00ff88;
        animation: pulse 2s infinite;
      }

      .status-dot.disconnected {
        background: #ff6b6b;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 1.5rem;
        padding: 2rem;
        min-height: calc(100vh - 80px);
      }

      .card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        border-color: rgba(0, 212, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #ffffff;
      }

      .card-icon {
        font-size: 1.2rem;
        color: #00d4ff;
      }

      /* Agent Activity Feed */
      .agent-activity {
        grid-column: 1;
        grid-row: 1 / 3;
        max-height: 600px;
        overflow-y: auto;
      }

      .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border-left: 4px solid;
        animation: slideInLeft 0.5s ease-out;
      }

      @keyframes slideInLeft {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .activity-detection {
        border-left-color: #ff6b6b;
      }
      .activity-diagnosis {
        border-left-color: #4ecdc4;
      }
      .activity-prediction {
        border-left-color: #45b7d1;
      }
      .activity-resolution {
        border-left-color: #f9ca24;
      }
      .activity-communication {
        border-left-color: #6c5ce7;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        flex-shrink: 0;
      }

      .activity-detection .activity-icon {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      }
      .activity-diagnosis .activity-icon {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
      }
      .activity-prediction .activity-icon {
        background: linear-gradient(135deg, #45b7d1, #96c93d);
      }
      .activity-resolution .activity-icon {
        background: linear-gradient(135deg, #f9ca24, #f0932b);
      }
      .activity-communication .activity-icon {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      }

      .activity-content {
        flex: 1;
      }

      .activity-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .activity-description {
        color: #ccc;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .activity-details {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
      }

      .activity-timestamp {
        font-size: 0.8rem;
        color: #888;
        margin-top: 0.5rem;
      }

      .confidence-bar {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #f9ca24, #00ff88);
        border-radius: 2px;
        transition: width 0.5s ease;
      }

      /* Control Panel */
      .control-panel {
        grid-column: 2;
        grid-row: 1;
      }

      .scenario-buttons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      .scenario-btn {
        padding: 1rem;
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-align: left;
      }

      .scenario-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 92, 231, 0.3);
      }

      .scenario-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .scenario-btn i {
        font-size: 1.2rem;
      }

      /* Performance Metrics */
      .performance-metrics {
        grid-column: 2;
        grid-row: 2;
      }

      .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .metric-item:last-child {
        border-bottom: none;
      }

      .metric-value {
        font-weight: 600;
        color: #00ff88;
      }

      /* Current Incident */
      .current-incident {
        grid-column: 1 / 3;
        grid-row: 3;
      }

      .incident-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        border-radius: 12px;
      }

      .incident-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .incident-timer {
        font-size: 1.5rem;
        font-weight: 700;
        color: #00ff88;
        font-family: "Courier New", monospace;
      }

      .incident-details {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
      }

      .detail-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 1rem;
      }

      .detail-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #00d4ff;
      }

      .detail-list {
        list-style: none;
      }

      .detail-list li {
        padding: 0.25rem 0;
        font-size: 0.9rem;
        color: #ccc;
      }

      .detail-list li:before {
        content: "•";
        color: #00ff88;
        margin-right: 0.5rem;
      }

      /* Status indicators */
      .status-pending {
        color: #f9ca24;
      }
      .status-in-progress {
        color: #45b7d1;
      }
      .status-completed {
        color: #00ff88;
      }
      .status-failed {
        color: #ff6b6b;
      }

      /* Responsive design */
      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto auto;
        }

        .agent-activity {
          grid-column: 1;
          grid-row: 1;
          max-height: 400px;
        }

        .control-panel {
          grid-column: 1;
          grid-row: 2;
        }

        .performance-metrics {
          grid-column: 1;
          grid-row: 3;
        }

        .current-incident {
          grid-column: 1;
          grid-row: 4;
        }
      }
    </style>
  </head>
  <body>
    <!-- Dashboard Header -->
    <header class="dashboard-header">
      <div class="logo">
        <i class="fas fa-robot"></i>
        <h1>Autonomous Incident Commander</h1>
        <span style="font-size: 0.8rem; color: #888; margin-left: 1rem"
          >Live Backend Integration</span
        >
      </div>
      <div class="connection-status">
        <div class="status-indicator">
          <div class="status-dot" id="connection-dot"></div>
          <span id="connection-status">Connecting...</span>
        </div>
      </div>
    </header>

    <!-- Main Dashboard Grid -->
    <main class="main-grid">
      <!-- Agent Activity Feed -->
      <section class="card agent-activity">
        <div class="card-header">
          <h2 class="card-title">Live Agent Activity Feed</h2>
          <i class="fas fa-stream card-icon"></i>
        </div>
        <div id="activity-feed">
          <div class="activity-item activity-detection">
            <div class="activity-icon">
              <i class="fas fa-search"></i>
            </div>
            <div class="activity-content">
              <div class="activity-title">System Ready</div>
              <div class="activity-description">
                All agents initialized and ready for incident response
              </div>
              <div class="activity-timestamp">System startup</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Control Panel -->
      <section class="card control-panel">
        <div class="card-header">
          <h2 class="card-title">Incident Triggers</h2>
          <i class="fas fa-gamepad card-icon"></i>
        </div>
        <div class="scenario-buttons">
          <button class="scenario-btn" data-scenario="database">
            <i class="fas fa-database"></i>
            <div>
              <div>Database Cascade</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                Connection pool exhaustion
              </div>
            </div>
          </button>
          <button class="scenario-btn" data-scenario="ddos">
            <i class="fas fa-shield-alt"></i>
            <div>
              <div>DDoS Attack</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                Traffic spike mitigation
              </div>
            </div>
          </button>
          <button class="scenario-btn" data-scenario="memory">
            <i class="fas fa-memory"></i>
            <div>
              <div>Memory Leak</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                OOM error recovery
              </div>
            </div>
          </button>
          <button class="scenario-btn" data-scenario="api">
            <i class="fas fa-plug"></i>
            <div>
              <div>API Overload</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                Rate limit activation
              </div>
            </div>
          </button>
          <button class="scenario-btn" data-scenario="storage">
            <i class="fas fa-hdd"></i>
            <div>
              <div>Storage Failure</div>
              <div style="font-size: 0.8rem; opacity: 0.8">
                Failover and replication
              </div>
            </div>
          </button>
        </div>
      </section>

      <!-- Performance Metrics -->
      <section class="card performance-metrics">
        <div class="card-header">
          <h2 class="card-title">Live Metrics</h2>
          <i class="fas fa-chart-line card-icon"></i>
        </div>
        <div class="metric-item">
          <span>Incidents Resolved</span>
          <span class="metric-value" id="incidents-resolved">2,847</span>
        </div>
        <div class="metric-item">
          <span>Cost Savings</span>
          <span class="metric-value" id="cost-savings">$1.24M</span>
        </div>
        <div class="metric-item">
          <span>Avg MTTR</span>
          <span class="metric-value" id="avg-mttr">167s</span>
        </div>
        <div class="metric-item">
          <span>Success Rate</span>
          <span class="metric-value" id="success-rate">92.5%</span>
        </div>
      </section>

      <!-- Current Incident -->
      <section
        class="card current-incident"
        id="current-incident"
        style="display: none"
      >
        <div class="card-header">
          <h2 class="card-title">Active Incident</h2>
          <i class="fas fa-exclamation-triangle card-icon"></i>
        </div>
        <div class="incident-header">
          <div>
            <div class="incident-title" id="incident-title">
              No Active Incident
            </div>
            <div
              style="font-size: 0.9rem; color: #ccc; margin-top: 0.25rem"
              id="incident-description"
            ></div>
          </div>
          <div class="incident-timer" id="incident-timer">0:00</div>
        </div>
        <div class="incident-details">
          <div class="detail-card">
            <div class="detail-title">Affected Services</div>
            <ul class="detail-list" id="affected-services"></ul>
          </div>
          <div class="detail-card">
            <div class="detail-title">Key Metrics</div>
            <ul class="detail-list" id="key-metrics"></ul>
          </div>
          <div class="detail-card">
            <div class="detail-title">Agent Status</div>
            <ul class="detail-list" id="agent-status"></ul>
          </div>
        </div>
      </section>
    </main>

    <script>
      class LiveDashboard {
        constructor() {
          this.ws = null;
          this.currentIncident = null;
          this.incidentStartTime = null;
          this.timerInterval = null;
          this.metrics = {
            incidents_resolved: 2847,
            total_cost_savings: 1240000,
            avg_mttr: 167,
            success_rate: 0.925,
          };

          this.init();
        }

        init() {
          this.connectWebSocket();
          this.setupEventListeners();
          this.updateMetricsDisplay();
        }

        connectWebSocket() {
          const protocol =
            window.location.protocol === "https:" ? "wss:" : "ws:";
          // Use localhost:8000 for development, or current host for production
          const host =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
              ? "localhost:8000"
              : window.location.host;
          const wsUrl = `${protocol}//${host}/ws`;

          console.log("🔌 Connecting to WebSocket:", wsUrl);

          this.ws = new WebSocket(wsUrl);

          this.ws.onopen = () => {
            console.log("✅ WebSocket connected");
            this.updateConnectionStatus(true);
          };

          this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleWebSocketMessage(data);
          };

          this.ws.onclose = () => {
            console.log("❌ WebSocket disconnected");
            this.updateConnectionStatus(false);
            // Attempt to reconnect after 3 seconds
            setTimeout(() => this.connectWebSocket(), 3000);
          };

          this.ws.onerror = (error) => {
            console.error("🚨 WebSocket error:", error);
            this.updateConnectionStatus(false);
          };
        }

        updateConnectionStatus(connected) {
          const dot = document.getElementById("connection-dot");
          const status = document.getElementById("connection-status");

          if (connected) {
            dot.classList.remove("disconnected");
            status.textContent = "Backend Connected";
          } else {
            dot.classList.add("disconnected");
            status.textContent = "Backend Disconnected";
          }
        }

        handleWebSocketMessage(data) {
          console.log("📡 Received:", data);

          switch (data.type) {
            case "incident_started":
              this.handleIncidentStarted(data.incident);
              break;
            case "agent_action":
              this.handleAgentAction(data.action);
              break;
            case "incident_resolved":
              this.handleIncidentResolved(data.incident, data.metrics);
              break;
          }
        }

        handleIncidentStarted(incident) {
          console.log("🚨 Incident started:", incident.title);

          this.currentIncident = incident;
          this.incidentStartTime = new Date(incident.created_at);

          // Show incident panel
          const incidentPanel = document.getElementById("current-incident");
          incidentPanel.style.display = "block";

          // Update incident details
          document.getElementById("incident-title").textContent =
            incident.title;
          document.getElementById("incident-description").textContent =
            incident.description;

          // Update affected services
          const servicesList = document.getElementById("affected-services");
          servicesList.innerHTML = incident.affected_services
            .map((service) => `<li>${service}</li>`)
            .join("");

          // Update key metrics
          const metricsList = document.getElementById("key-metrics");
          metricsList.innerHTML = Object.entries(incident.metrics)
            .map(
              ([key, value]) =>
                `<li>${key.replace(/_/g, " ")}: ${value}${
                  typeof value === "number" && value > 100 ? "" : "%"
                }</li>`
            )
            .join("");

          // Start timer
          this.startIncidentTimer();

          // Add to activity feed
          this.addActivityItem({
            agent_type: "detection",
            description: `🚨 New incident detected: ${incident.title}`,
            details: {
              severity: incident.severity,
              affected_services: incident.affected_services.length,
              initial_metrics: Object.keys(incident.metrics).length,
            },
            timestamp: new Date().toISOString(),
            confidence: 1.0,
          });
        }

        handleAgentAction(action) {
          console.log("🤖 Agent action:", action.description);

          // Add to activity feed
          this.addActivityItem(action);

          // Update agent status
          this.updateAgentStatus(action.agent_type, action.status);
        }

        handleIncidentResolved(incident, metrics) {
          console.log("✅ Incident resolved:", incident.title);

          // Stop timer
          if (this.timerInterval) {
            clearInterval(this.timerInterval);
          }

          // Update metrics
          this.metrics = metrics;
          this.updateMetricsDisplay();

          // Add resolution to activity feed
          this.addActivityItem({
            agent_type: "communication",
            description: `✅ Incident resolved: ${incident.title}`,
            details: {
              resolution_time: `${incident.resolution_time}s`,
              actions_executed: incident.actions.length,
              success: true,
            },
            timestamp: new Date().toISOString(),
            confidence: 1.0,
            status: "completed",
          });

          // Hide incident panel after 5 seconds
          setTimeout(() => {
            document.getElementById("current-incident").style.display = "none";
            this.currentIncident = null;
          }, 5000);
        }

        addActivityItem(action) {
          const feed = document.getElementById("activity-feed");

          const agentIcons = {
            detection: "fas fa-search",
            diagnosis: "fas fa-stethoscope",
            prediction: "fas fa-crystal-ball",
            resolution: "fas fa-tools",
            communication: "fas fa-comments",
          };

          const statusClasses = {
            pending: "status-pending",
            in_progress: "status-in-progress",
            completed: "status-completed",
            failed: "status-failed",
          };

          const item = document.createElement("div");
          item.className = `activity-item activity-${action.agent_type}`;

          const detailsHtml = action.details
            ? `<div class="activity-details">${JSON.stringify(
                action.details,
                null,
                2
              )}</div>`
            : "";

          const confidenceHtml = action.confidence
            ? `<div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${
                          action.confidence * 100
                        }%"></div>
                    </div>`
            : "";

          const statusHtml = action.status
            ? `<span class="${
                statusClasses[action.status]
              }">[${action.status.toUpperCase()}]</span>`
            : "";

          item.innerHTML = `
                    <div class="activity-icon">
                        <i class="${
                          agentIcons[action.agent_type] || "fas fa-cog"
                        }"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">
                            ${
                              action.agent_type.charAt(0).toUpperCase() +
                              action.agent_type.slice(1)
                            } Agent
                            ${statusHtml}
                        </div>
                        <div class="activity-description">${
                          action.description
                        }</div>
                        ${detailsHtml}
                        ${confidenceHtml}
                        <div class="activity-timestamp">${new Date(
                          action.timestamp
                        ).toLocaleTimeString()}</div>
                    </div>
                `;

          // Add to top of feed
          feed.insertBefore(item, feed.firstChild);

          // Remove old items (keep last 20)
          while (feed.children.length > 20) {
            feed.removeChild(feed.lastChild);
          }
        }

        updateAgentStatus(agentType, status) {
          const statusList = document.getElementById("agent-status");
          if (!statusList) return;

          // Find existing status or create new
          let statusItem = statusList.querySelector(
            `[data-agent="${agentType}"]`
          );
          if (!statusItem) {
            statusItem = document.createElement("li");
            statusItem.setAttribute("data-agent", agentType);
            statusList.appendChild(statusItem);
          }

          const statusClasses = {
            pending: "status-pending",
            in_progress: "status-in-progress",
            completed: "status-completed",
            failed: "status-failed",
          };

          statusItem.innerHTML = `
                    <span class="${
                      statusClasses[status] || ""
                    }">${agentType}: ${status}</span>
                `;
        }

        startIncidentTimer() {
          if (this.timerInterval) {
            clearInterval(this.timerInterval);
          }

          this.timerInterval = setInterval(() => {
            if (this.incidentStartTime) {
              const elapsed = Math.floor(
                (Date.now() - this.incidentStartTime.getTime()) / 1000
              );
              const minutes = Math.floor(elapsed / 60);
              const seconds = elapsed % 60;

              const timerElement = document.getElementById("incident-timer");
              if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds
                  .toString()
                  .padStart(2, "0")}`;

                // Change color based on time
                if (elapsed > 180) {
                  timerElement.style.color = "#ff6b6b";
                } else if (elapsed > 120) {
                  timerElement.style.color = "#f9ca24";
                } else {
                  timerElement.style.color = "#00ff88";
                }
              }
            }
          }, 1000);
        }

        updateMetricsDisplay() {
          document.getElementById("incidents-resolved").textContent =
            this.metrics.incidents_resolved.toLocaleString();
          document.getElementById("cost-savings").textContent = `$${(
            this.metrics.total_cost_savings / 1000000
          ).toFixed(2)}M`;
          document.getElementById(
            "avg-mttr"
          ).textContent = `${this.metrics.avg_mttr}s`;
          document.getElementById("success-rate").textContent = `${(
            this.metrics.success_rate * 100
          ).toFixed(1)}%`;
        }

        setupEventListeners() {
          // Scenario buttons
          document.querySelectorAll(".scenario-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const scenario = e.currentTarget.dataset.scenario;
              await this.triggerScenario(scenario);
            });
          });
        }

        async triggerScenario(scenarioType) {
          console.log("🎯 Triggering scenario:", scenarioType);

          // Disable buttons during processing
          document.querySelectorAll(".scenario-btn").forEach((btn) => {
            btn.disabled = true;
          });

          try {
            // Map scenario types to API format
            const scenarioMap = {
              database: "database_cascade",
              ddos: "ddos_attack",
              memory: "memory_leak",
              api: "api_overload",
              storage: "storage_failure",
            };

            const apiScenario = scenarioMap[scenarioType] || scenarioType;
            const apiUrl =
              window.location.hostname === "localhost" ||
              window.location.hostname === "127.0.0.1"
                ? `http://localhost:8000/demo/scenarios/${apiScenario}`
                : `/demo/scenarios/${apiScenario}`;

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              const result = await response.json();
              console.log("✅ Scenario triggered:", result);
            } else {
              console.error(
                "❌ Failed to trigger scenario:",
                response.statusText
              );
            }
          } catch (error) {
            console.error("❌ Error triggering scenario:", error);
          } finally {
            // Re-enable buttons after 5 seconds
            setTimeout(() => {
              document.querySelectorAll(".scenario-btn").forEach((btn) => {
                btn.disabled = false;
              });
            }, 5000);
          }
        }
      }

      // Initialize dashboard when page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("🚀 Initializing Live Dashboard");
        new LiveDashboard();
      });
    </script>
  </body>
</html>
